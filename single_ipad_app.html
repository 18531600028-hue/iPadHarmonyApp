<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ„Ÿå®˜å’Œè°ç³»ç»Ÿ - iPad ä¹å™¨åŸå‹</title>

    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            height: 100vh;
            margin: 0;
            background-color: #f9f9f9;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: #333;
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.5s; /* æ·»åŠ ä¸»é¢˜åˆ‡æ¢è¿‡æ¸¡ */
        }
        .control-container {
            padding: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 
                        0 4px 6px rgba(0, 0, 0, 0.05); 
            margin-bottom: 20px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        h3 { color: #4a4a4a; font-weight: 500; margin-top: 0; }
        p { margin: 5px 0; font-size: 0.9em; }

        /* RQ1ï¼šéŸ³é‡æ§åˆ¶æ»‘å—æ ·å¼ */
        #volume-slider { 
            width: 100%; height: 8px; 
            -webkit-appearance: none; 
            background: #e0e0e0;
            border-radius: 4px;
            margin: 15px 0;
        }
        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px; height: 24px;
            border-radius: 50%;
            background: #1e90ff; 
            cursor: pointer;
            box-shadow: 0 0 10px rgba(30, 144, 255, 0.5);
        }

        /* RQ3/RQ2ï¼šä¹å®«æ ¼ä¹å™¨æ ·å¼ */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 10px;
            width: 90%;
            max-width: 400px;
            aspect-ratio: 1 / 1;
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15), 
                        0 6px 10px rgba(0, 0, 0, 0.1); 
            padding: 10px;
        }
        .grid-cell {
            background-color: #f0f0f0;
            border-radius: 8px;
            transition: all 0.1s ease-out;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .active-cell {
            background-color: #ffb833 !important; 
            box-shadow: 0 0 25px rgba(255, 184, 51, 0.7);
            transform: scale(0.98); 
        }
        
        /* ä¸»é¢˜æ ·å¼ (RQ1 è¿›é˜¶) */
        .theme-calm { background-color: #e0f7fa; } /* æŸ”å’Œçš„æµ…è“ */
        .theme-energetic { background-color: #ffedb3; } /* æ´»åŠ›çš„æµ…é»„ */
    </style>
</head>
<body>
    
    <div id="volume-control" class="control-container">
        <h3>æ„Ÿå®˜éŸ³é‡è°ƒèŠ‚ (RQ1)</h3>
        <input type="range" id="volume-slider" min="0" max="100" value="50">
        <p>å½“å‰éŸ³é‡: <span id="volume-value">50%</span></p>
    </div>

    <div class="control-container">
        <h3>æ„Ÿå®˜ä¸»é¢˜é¢„è®¾ (RQ1 è¿›é˜¶)</h3>
        <button onclick="setTheme('calm')">å¹³é™æ£®æ—</button>
        <button onclick="setTheme('energetic')">æ´»åŠ›å½©è™¹</button>
    </div>

    <div id="grid-container" class="control-container">
        <div class="grid-cell" data-note="1"></div>
        <div class="grid-cell" data-note="2"></div>
        <div class="grid-cell" data-note="3"></div>
        <div class="grid-cell" data-note="4"></div>
        <div class="grid-cell" data-note="5"></div>
        <div class="grid-cell" data-note="6"></div>
        <div class="grid-cell" data-note="7"></div>
        <div class="grid-cell" data-note="8"></div>
        <div class="grid-cell" data-note="9"></div>
    </div>
    
    <button id="start-button">ç‚¹å‡»å¯åŠ¨ä¼ æ„Ÿå™¨</button>
    <p id="log">ç­‰å¾…å¯åŠ¨...</p>

    <script>
        const volumeSlider = document.getElementById('volume-slider');
        const volumeValueSpan = document.getElementById('volume-value');
        const startButton = document.getElementById('start-button');
        const log = document.getElementById('log');
        const cells = document.querySelectorAll('.grid-cell');
        
        // 1. åˆå§‹åŒ– 11 ä¸ªéŸ³é¢‘å¯¹è±¡
        const harmonicSounds = [];
        for (let i = 1; i <= 9; i++) {
            const audio = new Audio(`./sounds/note${i}.mp3`);
            audio.preload = 'auto'; 
            harmonicSounds.push(audio);
        }
        const magicSound = new Audio('./sounds/magic.mp3'); 
        const calmBG = new Audio('./sounds/calm_bg.mp3');
        calmBG.loop = true;
        calmBG.volume = 0.2; // èƒŒæ™¯éŸ³é‡è°ƒä½

        // ------------------- RQ1: æ„Ÿå®˜è°ƒèŠ‚é€»è¾‘ -------------------
        function updateVolume() {
            const volumeLevel = volumeSlider.value / 100;
            volumeValueSpan.textContent = volumeSlider.value + '%';
            
            harmonicSounds.forEach(audio => { audio.volume = volumeLevel; });
            magicSound.volume = volumeLevel;
            calmBG.volume = volumeLevel * 0.4; // èƒŒæ™¯éŸ³éšä¸»éŸ³é‡è°ƒèŠ‚
        }
        volumeSlider.addEventListener('input', updateVolume);
        updateVolume(); 
        
        // RQ1 è¿›é˜¶ï¼šä¸»é¢˜åˆ‡æ¢é€»è¾‘
        function setTheme(themeName) {
            document.body.classList.remove('theme-calm', 'theme-energetic');
            
            if (themeName === 'calm') {
                document.body.classList.add('theme-calm');
                calmBG.play().catch(e => console.error("èƒŒæ™¯éŸ³æ’­æ”¾å¤±è´¥", e));
            } else if (themeName === 'energetic') {
                document.body.classList.add('theme-energetic');
                calmBG.pause();
            }
        }


        // ------------------- RQ2/RQ3: æ‘‡æ™ƒäº¤äº’é€»è¾‘ -------------------
        let isListening = false;
        let lastPlayedNote = null;
        let lastMotionTime = 0;
        
        const SHAKE_THRESHOLD = 5.0; 
        const MAGIC_DURATION_MS = 3000; 
        const DEBOUNCE_MS = 200; 
        let shakeTimer = null; 

        function playNote(noteIndex) {
            const audioIndex = noteIndex - 1; 
            const audio = harmonicSounds[audioIndex];
            audio.currentTime = 0; 
            audio.play().catch(e => console.error("æ’­æ”¾å¤±è´¥:", e));
            updateGrid(noteIndex);
        }
        
        function updateGrid(noteIndex) {
            cells.forEach(cell => cell.classList.remove('active-cell'));
            if (noteIndex) {
                const activeCell = document.querySelector(`.grid-cell[data-note="${noteIndex}"]`);
                if (activeCell) activeCell.classList.add('active-cell');
                setTimeout(() => { if (activeCell) activeCell.classList.remove('active-cell'); }, 150);
            }
        }
        
        // RQ2 æ ¸å¿ƒï¼šé­”æ³•æœºåˆ¶çš„æ£€æµ‹ä¸å¥–åŠ± (æŒç»­æ‘‡æ™ƒå¥–åŠ±)
        function checkMagicMoment() {
            clearTimeout(shakeTimer); 
            
            shakeTimer = setTimeout(() => {
                magicSound.currentTime = 0; 
                magicSound.play().catch(e => console.error("é­”æ³•éŸ³æ’­æ”¾å¤±è´¥:", e));
                log.textContent = "ğŸŒŸ é­”æ³•æ—¶åˆ»ï¼ä½ æ‰¾åˆ°äº†æŒç»­çš„èŠ‚å¥ï¼ğŸŒŸ";
                
                // è§†è§‰å¥–åŠ±
                cells.forEach(cell => cell.classList.add('active-cell'));
                setTimeout(() => { cells.forEach(cell => cell.classList.remove('active-cell')); }, 500);
                
                clearTimeout(shakeTimer);
            }, MAGIC_DURATION_MS);

            log.textContent = `æŒç»­æ‘‡æ™ƒä¸­...`;
        }


        // æ ¸å¿ƒå¤„ç†å‡½æ•°ï¼šå°†è¿åŠ¨æ˜ å°„åˆ°éŸ³ç¬¦
        function handleMotion(event) {
            if (!isListening) return;

            const currentTime = Date.now();
            if (currentTime - lastMotionTime < DEBOUNCE_MS) return; 

            const acc = event.accelerationIncludingGravity;
            const x = acc.x || 0;
            const y = acc.y || 0;
            
            const magnitude = Math.sqrt(x * x + y * y);
            
            if (magnitude > SHAKE_THRESHOLD) {
                
                // æ˜ å°„é€»è¾‘ (RQ3å·®å¼‚è¾“å…¥): 3x3 = 9 ä¸ªéŸ³ç¬¦
                let x_area = 0; 
                if (x > 2) x_area = 2; else if (x < -2) x_area = 0; else x_area = 1;

                let y_area = 0; 
                if (y > 2) y_area = 2; else if (y < -2) y_area = 0; else y_area = 1;
                
                const currentNote = (y_area * 3) + x_area + 1; 

                playNote(currentNote);    // æ’­æ”¾å’Œè°éŸ³ç¬¦ (RQ3)
                checkMagicMoment();       // æ£€æŸ¥æ˜¯å¦æŒç»­æ‘‡æ™ƒ (RQ2)
                
                lastPlayedNote = currentNote;
                lastMotionTime = currentTime;
            } else {
                updateGrid(null); // åœæ­¢æ‘‡æ™ƒæ—¶æ¸…é™¤è§†è§‰åé¦ˆ
            }
        }


        // ------------------- å¯åŠ¨æŒ‰é’®å’Œæƒé™è¯·æ±‚ (iOS å¿…éœ€) -------------------
        startButton.addEventListener('click', () => {
            // è§£é” AudioContext
            new Audio().play().catch(() => {});

            // è¯·æ±‚ DeviceMotion æƒé™ (iOS 13+ å¿…éœ€)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            isListening = true;
                            window.addEventListener('devicemotion', handleMotion);
                            startButton.style.display = 'none';
                            log.textContent = "ä¼ æ„Ÿå™¨å·²å¯åŠ¨ï¼è¯·å¼€å§‹æ‘‡æ™ƒ iPadã€‚";
                        } else {
                            log.textContent = "æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸ã€‚";
                        }
                    });
            } else {
                isListening = true;
                window.addEventListener('devicemotion', handleMotion);
                startButton.style.display = 'none';
                log.textContent = "ä¼ æ„Ÿå™¨å·²å¯åŠ¨ï¼è¯·å¼€å§‹æ‘‡æ™ƒ iPadã€‚";
            }
        });
    </script>
</body>
</html>